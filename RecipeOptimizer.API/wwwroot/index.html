<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Optimizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ffffff;
            --secondary-color: #f9f9f9;
            --accent-color: #3a86ff;
            --dark-bg: #121212;
            --card-bg: #1e1e1e;
            --card-header: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --success-color: #4caf50;
            --info-color: #2196f3;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --highlight-color: #ffb42c;
            --border-color: rgba(255, 255, 255, 0.1);
            --card-hover: rgba(255, 255, 255, 0.1);
        }
        
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 1200px;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .card {
            background-color: var(--card-bg);
            border: none;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--card-header);
            color: var(--primary-color);
            font-weight: 600;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .recipe-card {
            transition: transform 0.3s ease;
        }
        
        .recipe-card:hover {
            transform: translateY(-5px);
        }
        
        .ingredient-list {
            margin-top: 1rem;
        }
        
        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.75rem 1rem;
            background-color: rgba(255,255,255,0.05);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .ingredient-item:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .badge {
            font-weight: 500;
            padding: 0.5em 0.8em;
            border-radius: 6px;
        }
        
        .badge-secondary {
            background-color: #2a2a2a;
            color: var(--text-secondary);
        }
        
        .badge.bg-primary {
            background-color: var(--accent-color) !important;
        }
        
        .badge.bg-success {
            background-color: var(--success-color) !important;
        }
        
        .badge-secondary {
            background-color: #555;
            color: white;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            border: none;
            border-radius: 30px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(58, 134, 255, 0.3);
        }
        
        .btn-primary:hover {
            background-color: #2a75e8;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(58, 134, 255, 0.4);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border: none;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-success:hover {
            background-color: #3d9140;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #2a2a2a;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        
        .btn-secondary:hover {
            background-color: #333333;
            color: var(--text-primary);
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-header);
            padding: 1.25rem;
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1.25rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .result-section {
            background-color: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .alert-info {
            background-color: rgba(33, 150, 243, 0.15);
            border: 1px solid rgba(33, 150, 243, 0.3);
            color: var(--text-primary);
        }
        
        .form-control, .form-select {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(58, 134, 255, 0.25);
        }
        
        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        ul {
            padding-left: 1.2rem;
        }
        
        li {
            margin-bottom: 0.5rem;
        }
        
        .spinner-border {
            color: var(--accent-color);
        }
        
        /* Chart styles for optimization results */
        .chart-container {
            margin-top: 2rem;
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 10px;
        }
        
        .chart-bar {
            background: linear-gradient(to top, var(--accent-color), #65a3ff);
            border-radius: 6px 6px 0 0;
            width: 40px;
            position: relative;
            transition: height 0.5s ease;
        }
        
        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Consistent container sizing for ingredients and recipes */
        .card {
            height: 500px; /* Fixed height for all cards */
        }
        
        .card-body {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Consistent styling for ingredient and recipe items */
        .ingredient-item,
        .recipe-item {
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0.75rem !important;
            margin-bottom: 0.5rem !important;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .ingredient-item:hover,
        .recipe-item:hover {
            background-color: var(--card-hover);
            transform: translateY(-1px);
        }
        
        .btn-outline-warning {
            color: var(--highlight-color);
            border-color: var(--highlight-color);
        }
        
        .btn-outline-warning:hover {
            background-color: var(--highlight-color);
            color: #000;
        }
        
        .btn-outline-danger {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        #ingredients-container,
        #recipes-container {
            flex: 1;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
            margin: 0;
        }
        
        /* Custom scrollbar styling */
        #ingredients-container::-webkit-scrollbar,
        #recipes-container::-webkit-scrollbar {
            width: 6px;
        }
        
        #ingredients-container::-webkit-scrollbar-track,
        #recipes-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        #ingredients-container::-webkit-scrollbar-thumb,
        #recipes-container::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 3px;
        }
        
        #ingredients-container::-webkit-scrollbar-thumb:hover,
        #recipes-container::-webkit-scrollbar-thumb:hover {
            background: #65a3ff;
        }
        
        /* Modal centering and styling - only when shown */
        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        
        .modal-dialog {
            margin: 0;
            max-width: 90vw;
            max-height: 90vh;
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Ensure modals are properly centered on all screen sizes */
        @media (min-width: 576px) {
            .modal-dialog {
                max-width: 500px;
            }
        }
        
        @media (min-width: 992px) {
            .modal-dialog {
                max-width: 800px;
            }
        }
        
        /* Compact optimization results */
        #optimal-recipes .alert,
        #remaining-ingredients .alert {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        #optimal-recipes .alert-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #remaining-ingredients .alert {
            display: inline-block;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            width: calc(50% - 0.5rem);
        }
        
        @media (min-width: 768px) {
            #remaining-ingredients .alert {
                width: calc(33.33% - 0.5rem);
            }
        }
        
        .result-section h3, .result-section h4 {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4" style="color: white;">Recipe Optimizer</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-carrot me-2" style="color: white;"></i>Available Ingredients</span>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addIngredientModal">
                            <i class="fas fa-plus me-1"></i> Add Ingredient
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="ingredients-container">
                            <!-- Ingredients will be loaded here -->
                            <div class="d-flex justify-content-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-utensils me-2" style="color: white;"></i>Available Recipes</span>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addRecipeModal">
                            <i class="fas fa-plus me-1"></i> Add Recipe
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="recipes-container">
                            <!-- Recipes will be loaded here -->
                            <div class="d-flex justify-content-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4 mb-5">
            <div class="col-12 text-center">
                <button id="optimize-btn" class="btn btn-primary btn-lg">
                    <i class="fas fa-magic me-2" style="color: white;"></i>Optimize Recipes
                </button>
            </div>
        </div>
        

        
        <!-- Add Ingredient Modal -->
        <div class="modal fade" id="addIngredientModal" tabindex="-1" aria-labelledby="addIngredientModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addIngredientModalLabel"><i class="fas fa-plus-circle me-2" style="color: white;"></i>Add New Ingredient</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addIngredientForm">
                            <div class="mb-3">
                                <label for="ingredientName" class="form-label">Ingredient Name</label>
                                <input type="text" class="form-control" id="ingredientName" required>
                            </div>
                            <div class="mb-3">
                                <label for="ingredientQuantity" class="form-label">Quantity Available</label>
                                <input type="number" class="form-control" id="ingredientQuantity" min="1" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveIngredientBtn">Save Ingredient</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Ingredient Modal -->
        <div class="modal fade" id="editIngredientModal" tabindex="-1" aria-labelledby="editIngredientModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editIngredientModalLabel"><i class="fas fa-edit me-2" style="color: white;"></i>Edit Ingredient</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editIngredientForm">
                            <input type="hidden" id="editIngredientId">
                            <div class="mb-3">
                                <label for="editIngredientName" class="form-label">Ingredient Name</label>
                                <input type="text" class="form-control" id="editIngredientName" required>
                            </div>
                            <div class="mb-3">
                                <label for="editIngredientQuantity" class="form-label">Quantity Available</label>
                                <input type="number" class="form-control" id="editIngredientQuantity" min="1" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="updateIngredientBtn">Update Ingredient</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Ingredient Confirmation Modal -->
        <div class="modal fade" id="deleteIngredientModal" tabindex="-1" aria-labelledby="deleteIngredientModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteIngredientModalLabel"><i class="fas fa-trash-alt me-2" style="color: white;"></i>Delete Ingredient</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="deleteIngredientId">
                        <p>Are you sure you want to delete <span id="deleteIngredientName" class="fw-bold"></span>?</p>
                        <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteIngredientBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recipe Details Modal -->
        <div class="modal fade" id="recipeDetailsModal" tabindex="-1" aria-labelledby="recipeDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="recipeDetailsModalLabel">Recipe Name</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <span class="badge bg-success">Feeds <span id="recipeServingSize">0</span></span>
                        </div>
                        <h6><i class="fas fa-list me-2"></i>Required Ingredients:</h6>
                        <ul id="recipeIngredientsList" class="mt-2">
                            <!-- Ingredients will be displayed here -->
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Recipe Modal -->
        <div class="modal fade" id="addRecipeModal" tabindex="-1" aria-labelledby="addRecipeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addRecipeModalLabel"><i class="fas fa-plus-circle me-2" style="color: white;"></i>Add New Recipe</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addRecipeForm">
                            <div class="mb-3">
                                <label for="recipeName" class="form-label">Recipe Name</label>
                                <input type="text" class="form-control" id="recipeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="recipeServingSize" class="form-label">Serving Size</label>
                                <input type="number" class="form-control" id="recipeServingSize" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ingredients</label>
                                <div id="recipeIngredientsContainer">
                                    <div class="row mb-2 recipe-ingredient-row">
                                        <div class="col-md-8">
                                            <select class="form-select ingredient-select" required>
                                                <option value="">Select Ingredient</option>
                                                <!-- Options will be populated dynamically -->
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control ingredient-quantity" placeholder="Quantity" min="1" required>
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-danger remove-ingredient"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary mt-2" id="addIngredientToRecipeBtn">
                                    <i class="fas fa-plus me-1"></i> Add Another Ingredient
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveRecipeBtn">Save Recipe</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Recipe Modal -->
        <div class="modal fade" id="editRecipeModal" tabindex="-1" aria-labelledby="editRecipeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editRecipeModalLabel"><i class="fas fa-edit me-2" style="color: white;"></i>Edit Recipe</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editRecipeForm">
                            <input type="hidden" id="editRecipeId">
                            <div class="mb-3">
                                <label for="editRecipeName" class="form-label">Recipe Name</label>
                                <input type="text" class="form-control" id="editRecipeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="editRecipeServingSize" class="form-label">Serving Size</label>
                                <input type="number" class="form-control" id="editRecipeServingSize" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ingredients</label>
                                <div id="editRecipeIngredientsContainer">
                                    <!-- Ingredient rows will be added dynamically -->
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary mt-2" id="addIngredientToEditRecipeBtn">
                                    <i class="fas fa-plus me-1"></i> Add Another Ingredient
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="updateRecipeBtn">Update Recipe</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Recipe Confirmation Modal -->
        <div class="modal fade" id="deleteRecipeModal" tabindex="-1" aria-labelledby="deleteRecipeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteRecipeModalLabel"><i class="fas fa-trash-alt me-2" style="color: white;"></i>Delete Recipe</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="deleteRecipeId">
                        <p>Are you sure you want to delete <span id="deleteRecipeName" class="fw-bold"></span>?</p>
                        <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteRecipeBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Modal -->
        <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="resultsModalLabel"><i class="fas fa-trophy me-2" style="color: white;"></i>Optimization Results</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="result-section">
                            <div class="d-flex justify-content-center py-4" id="results-loading">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            
                            <div id="results-content" class="d-none">
                                <h3>Total People Served: <span id="people-served" class="badge bg-success">0</span></h3>
                                
                                <h4 class="mt-4"><i class="fas fa-check-circle me-2"></i>Optimal Recipes</h4>
                                <div id="optimal-recipes" class="mt-3">
                                    <!-- Optimal recipes will be displayed here -->
                                </div>
                                
                                <h4 class="mt-4"><i class="fas fa-box me-2"></i>Remaining Ingredients</h4>
                                <div id="remaining-ingredients" class="mt-3">
                                    <!-- Remaining ingredients will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <!-- Save Results button removed as requested -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Global variables to store ingredients and recipes
            let allIngredients = [];
            let allRecipes = [];
            
            // Load initial data
            loadIngredients();
            loadRecipes();
            
            // Setup event listeners for forms
            setupEventListeners();
            
            // Function to load ingredients
            function loadIngredients() {
                const container = document.getElementById('ingredients-container');
                container.innerHTML = `
                    <div class="d-flex justify-content-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                fetch('/api/ingredients')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Ingredients API response:', data);
                        container.innerHTML = '';
                        
                        // Handle ASP.NET Core JSON reference format with $values
                        const ingredientsArray = Array.isArray(data) ? data : 
                                              (data.$values || data.value || []);
                        console.log('Processed ingredients array:', ingredientsArray);
                        
                        // Store ingredients globally
                        allIngredients = ingredientsArray;
                        
                        // Populate ingredient dropdowns in recipe forms
                        populateIngredientDropdowns();
                        
                        if (ingredientsArray.length === 0) {
                            container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No ingredients available. Add some ingredients to get started.</div>';
                            return;
                        }
                        
                        ingredientsArray.forEach(ingredient => {
                            // Skip $id properties
                            if (ingredient === '$id') return;
                            
                            const card = document.createElement('div');
                            card.className = 'd-flex justify-content-between align-items-center ingredient-item mb-2 p-2';
                            // Log the ingredient object to see its structure
                            console.log('Ingredient object:', ingredient);
                            
                            // Determine the correct property for quantity
                            // Log the ingredient object to see its structure
                            console.log('Processing ingredient:', ingredient);
                            
                            // More robust handling of quantity property
                            let quantity = 0;
                            if (ingredient.quantity !== undefined && ingredient.quantity !== null) {
                                quantity = ingredient.quantity;
                            } else if (ingredient.availableQuantity !== undefined && ingredient.availableQuantity !== null) {
                                quantity = ingredient.availableQuantity;
                            } else if (ingredient.available !== undefined && ingredient.available !== null) {
                                quantity = ingredient.available;
                            }
                            
                            // Ensure quantity is a number
                            quantity = parseInt(quantity) || 0;
                            
                            card.innerHTML = `
                                <div>
                                    <i class="fas fa-carrot me-2" style="color: white;"></i>${ingredient.name}
                                </div>
                                <div>
                                    <span class="badge bg-primary me-2">${quantity} available</span>
                                    <button class="btn btn-sm btn-outline-warning edit-ingredient-btn me-1" data-id="${ingredient.id}" data-name="${ingredient.name}" data-quantity="${quantity}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-ingredient-btn" data-id="${ingredient.id}" data-name="${ingredient.name}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                            container.appendChild(card);
                        });
                        
                        // Add event listeners for edit and delete buttons
                        addIngredientButtonListeners();
                    })
                    .catch(error => {
                        console.error('Error loading ingredients:', error);
                        container.innerHTML = 
                            '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading ingredients</div>';
                    });
            }
            
            // Function to load recipes
            function loadRecipes() {
                const container = document.getElementById('recipes-container');
                container.innerHTML = `
                    <div class="d-flex justify-content-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                fetch('/api/recipes')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Recipes API response:', data);
                        const container = document.getElementById('recipes-container');
                        container.innerHTML = '';
                        
                        // Handle ASP.NET Core JSON reference format with $values
                        const recipesArray = Array.isArray(data) ? data : 
                                              (data.$values || data.value || []);
                        console.log('Processed recipes array:', recipesArray);
                        
                        // Store recipes globally
                        allRecipes = recipesArray;
                        
                        // Create a list group for recipes
                        const listGroup = document.createElement('div');
                        listGroup.className = 'list-group';
                        container.appendChild(listGroup);
                        
                        recipesArray.forEach(recipe => {
                            // Skip $id properties
                            if (recipe === '$id') return;
                            
                            // Store recipe ingredients for later use in popup
                            const recipeIngredients = recipe.ingredients && recipe.ingredients.$values ? recipe.ingredients.$values : 
                                                   (recipe.ingredients || []);
                            
                            // Create a list item for each recipe
                            const listItem = document.createElement('a');
                            listItem.href = '#';
                            listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center recipe-item';
                            listItem.style.backgroundColor = 'rgba(255,255,255,0.05)';
                            listItem.style.border = '1px solid rgba(255,255,255,0.1)';
                            listItem.style.marginBottom = '0.5rem';
                            listItem.style.borderRadius = '8px';
                            listItem.style.transition = 'all 0.2s ease';
                            
                            listItem.innerHTML = `
                                <div>
                                    <i class="fas fa-utensils me-2" style="color: white;"></i>
                                    <span class="recipe-name" style="color: white;">${recipe.name}</span>
                                </div>
                                <span class="badge bg-success">Feeds ${recipe.servingSize}</span>
                            `;
                            
                            // Add hover effect
                            listItem.addEventListener('mouseover', function() {
                                this.style.backgroundColor = 'rgba(255,255,255,0.1)';
                                this.style.transform = 'translateY(-2px)';
                            });
                            
                            listItem.addEventListener('mouseout', function() {
                                this.style.backgroundColor = 'rgba(255,255,255,0.05)';
                                this.style.transform = 'translateY(0)';
                            });
                            
                            // Add click event to show ingredients popup
                            listItem.addEventListener('click', function(e) {
                                e.preventDefault();
                                
                                // Create ingredients list HTML
                                let ingredientsListHtml = '';
                                recipeIngredients.forEach(ri => {
                                    const ingredientName = ri.ingredient && ri.ingredient.name ? ri.ingredient.name : 'Unknown';
                                    ingredientsListHtml += `<li>${ri.requiredQuantity} x ${ingredientName}</li>`;
                                });
                                
                                // Set modal content
                                document.getElementById('recipeDetailsModalLabel').textContent = recipe.name;
                                document.getElementById('recipeServingSize').textContent = recipe.servingSize;
                                document.getElementById('recipeIngredientsList').innerHTML = ingredientsListHtml;
                                
                                // Show modal
                                const recipeDetailsModal = new bootstrap.Modal(document.getElementById('recipeDetailsModal'));
                                recipeDetailsModal.show();
                            });
                            
                            listGroup.appendChild(listItem);
                        });
                        
                        // Add event handlers for edit recipe buttons
                        document.querySelectorAll('.edit-recipe-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const recipeId = this.getAttribute('data-id');
                                
                                // Fetch recipe details
                                fetch(`/api/recipes/${recipeId}`)
                                    .then(response => response.json())
                                    .then(recipe => {
                                        console.log('Recipe to edit:', recipe);
                                        
                                        // Clear previous ingredients
                                        document.getElementById('editRecipeIngredientsContainer').innerHTML = '';
                                        
                                        // Populate form fields
                                        document.getElementById('editRecipeId').value = recipe.id;
                                        document.getElementById('editRecipeName').value = recipe.name;
                                        document.getElementById('editRecipeServingSize').value = recipe.servingSize;
                                        
                                        // Get recipe ingredients
                                        const recipeIngredients = recipe.ingredients && recipe.ingredients.$values ? 
                                            recipe.ingredients.$values : (recipe.ingredients || []);
                                        
                                        // Add ingredient rows
                                        recipeIngredients.forEach(ri => {
                                            const ingredientId = ri.ingredientId || (ri.ingredient ? ri.ingredient.id : null);
                                            const quantity = ri.requiredQuantity || ri.quantity || 0;
                                            
                                            if (!ingredientId) return;
                                            
                                            const newRow = document.createElement('div');
                                            newRow.className = 'row mb-2 recipe-ingredient-row';
                                            
                                            newRow.innerHTML = `
                                                <div class="col-md-8">
                                                    <select class="form-select ingredient-select" required>
                                                        <option value="">Select Ingredient</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control ingredient-quantity" value="${quantity}" placeholder="Quantity" min="1" required>
                                                </div>
                                                <div class="col-md-1">
                                                    <button type="button" class="btn btn-danger remove-ingredient"><i class="fas fa-times"></i></button>
                                                </div>
                                            `;
                                            
                                            document.getElementById('editRecipeIngredientsContainer').appendChild(newRow);
                                            
                                            // Add event listener to remove button
                                            newRow.querySelector('.remove-ingredient').addEventListener('click', function() {
                                                newRow.remove();
                                            });
                                            
                                            // Populate the dropdown
                                            const select = newRow.querySelector('.ingredient-select');
                                            allIngredients.forEach(ingredient => {
                                                if (ingredient === '$id') return;
                                                
                                                const option = document.createElement('option');
                                                option.value = ingredient.id;
                                                option.textContent = ingredient.name;
                                                option.selected = ingredient.id === ingredientId;
                                                select.appendChild(option);
                                            });
                                        });
                                        
                                        // Show modal
                                        const modal = new bootstrap.Modal(document.getElementById('editRecipeModal'));
                                        modal.show();
                                    })
                                    .catch(error => {
                                        console.error('Error fetching recipe details:', error);
                                        alert('Failed to load recipe details. Please try again.');
                                    });
                            });
                        });
                        
                        // Add event handlers for delete recipe buttons
                        document.querySelectorAll('.delete-recipe-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const recipeId = this.getAttribute('data-id');
                                const recipeName = this.getAttribute('data-name');
                                
                                // Set modal content
                                document.getElementById('deleteRecipeId').value = recipeId;
                                document.getElementById('deleteRecipeName').textContent = recipeName;
                                
                                // Show modal
                                const modal = new bootstrap.Modal(document.getElementById('deleteRecipeModal'));
                                modal.show();
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error loading recipes:', error);
                        document.getElementById('recipes-container').innerHTML = 
                            '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading recipes</div>';
                    });
            }
            
            // Function to add event listeners for ingredient buttons
            function addIngredientButtonListeners() {
                // Edit ingredient buttons
                document.querySelectorAll('.edit-ingredient-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const name = this.getAttribute('data-name');
                        const quantity = this.getAttribute('data-quantity');
                        
                        // Populate edit form
                        document.getElementById('editIngredientId').value = id;
                        document.getElementById('editIngredientName').value = name;
                        document.getElementById('editIngredientQuantity').value = quantity;
                        
                        // Show modal
                        const editModal = new bootstrap.Modal(document.getElementById('editIngredientModal'));
                        editModal.show();
                    });
                });
                
                // Delete ingredient buttons
                document.querySelectorAll('.delete-ingredient-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const name = this.getAttribute('data-name');
                        
                        // Populate delete confirmation
                        document.getElementById('deleteIngredientId').value = id;
                        document.getElementById('deleteIngredientName').textContent = name;
                        
                        // Show modal
                        const deleteModal = new bootstrap.Modal(document.getElementById('deleteIngredientModal'));
                        deleteModal.show();
                    });
                });
            }
            
            // Function to populate ingredient dropdowns in recipe forms
            function populateIngredientDropdowns() {
                const ingredientSelects = document.querySelectorAll('.ingredient-select');
                
                // Clear existing options except the first one
                ingredientSelects.forEach(select => {
                    const firstOption = select.querySelector('option:first-child');
                    select.innerHTML = '';
                    select.appendChild(firstOption);
                    
                    // Add ingredient options
                    allIngredients.forEach(ingredient => {
                        if (ingredient === '$id') return;
                        
                        const option = document.createElement('option');
                        option.value = ingredient.id;
                        option.textContent = ingredient.name;
                        select.appendChild(option);
                    });
                });
            }
            
            // Setup event listeners for forms and buttons
            function setupEventListeners() {
                // Add ingredient to edit recipe form
                document.getElementById('addIngredientToEditRecipeBtn').addEventListener('click', function() {
                    const container = document.getElementById('editRecipeIngredientsContainer');
                    const newRow = document.createElement('div');
                    newRow.className = 'row mb-2 recipe-ingredient-row';
                    
                    newRow.innerHTML = `
                        <div class="col-md-8">
                            <select class="form-select ingredient-select" required>
                                <option value="">Select Ingredient</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control ingredient-quantity" placeholder="Quantity" min="1" required>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-danger remove-ingredient"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    
                    container.appendChild(newRow);
                    
                    // Add event listener to remove button
                    newRow.querySelector('.remove-ingredient').addEventListener('click', function() {
                        newRow.remove();
                    });
                    
                    // Populate the new dropdown
                    const select = newRow.querySelector('.ingredient-select');
                    allIngredients.forEach(ingredient => {
                        if (ingredient === '$id') return;
                        
                        const option = document.createElement('option');
                        option.value = ingredient.id;
                        option.textContent = ingredient.name;
                        select.appendChild(option);
                    });
                });
                
                // Update Recipe functionality is now handled via event delegation in fix-ingredient-update.js
                // Removed old direct event listener to prevent duplicate API calls
                
                // Delete Recipe confirmation
                document.getElementById('confirmDeleteRecipeBtn').addEventListener('click', function() {
                    const id = document.getElementById('deleteRecipeId').value;
                    
                    if (!id) {
                        alert('Invalid recipe ID.');
                        return;
                    }
                    
                    // Send DELETE request to API
                    fetch(`/api/recipes/${id}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to delete recipe');
                        }
                        
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteRecipeModal'));
                        modal.hide();
                        
                        // Reload recipes
                        loadRecipes();
                    })
                    .catch(error => {
                        console.error('Error deleting recipe:', error);
                        alert('Failed to delete recipe. Please try again.');
                    });
                });
                // Update Ingredient form
                document.getElementById('updateIngredientBtn').addEventListener('click', function() {
                    const id = document.getElementById('editIngredientId').value;
                    const name = document.getElementById('editIngredientName').value.trim();
                    const quantity = parseInt(document.getElementById('editIngredientQuantity').value);
                    
                    if (!id || !name || isNaN(quantity) || quantity < 1) {
                        alert('Please enter a valid ingredient name and quantity.');
                        return;
                    }
                    
                    // Create ingredient object
                    const updatedIngredient = {
                        id: id,
                        name: name,
                        quantity: quantity
                    };
                    
                    // Send PUT request to API
                    fetch(`/api/ingredients/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedIngredient)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to update ingredient');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editIngredientModal'));
                        modal.hide();
                        
                        // Reload ingredients
                        loadIngredients();
                    })
                    .catch(error => {
                        console.error('Error updating ingredient:', error);
                        alert('Failed to update ingredient. Please try again.');
                    });
                });
                
                // Add Ingredient form
                document.getElementById('saveIngredientBtn').addEventListener('click', function() {
                    const name = document.getElementById('ingredientName').value.trim();
                    const quantity = parseInt(document.getElementById('ingredientQuantity').value);
                    
                    if (!name || isNaN(quantity) || quantity < 1) {
                        alert('Please enter a valid ingredient name and quantity.');
                        return;
                    }
                    
                    // Create ingredient object
                    const newIngredient = {
                        name: name,
                        quantity: quantity
                    };
                    
                    // Send POST request to API
                    fetch('/api/ingredients', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newIngredient)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to add ingredient');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addIngredientModal'));
                        modal.hide();
                        
                        // Clear form
                        document.getElementById('ingredientName').value = '';
                        document.getElementById('ingredientQuantity').value = '';
                        
                        // Reload ingredients
                        loadIngredients();
                    })
                    .catch(error => {
                        console.error('Error adding ingredient:', error);
                        alert('Failed to add ingredient. Please try again.');
                    });
                });
                
                // Update Ingredient form
                document.getElementById('updateIngredientBtn').addEventListener('click', function() {
                    const id = document.getElementById('editIngredientId').value;
                    const name = document.getElementById('editIngredientName').value.trim();
                    const quantity = parseInt(document.getElementById('editIngredientQuantity').value);
                    
                    if (!id || !name || isNaN(quantity) || quantity < 1) {
                        alert('Please enter a valid ingredient name and quantity.');
                        return;
                    }
                    
                    // Create ingredient object
                    const updatedIngredient = {
                        id: id,
                        name: name,
                        quantity: quantity
                    };
                    
                    // Send PUT request to API
                    fetch(`/api/ingredients/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedIngredient)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to update ingredient');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editIngredientModal'));
                        modal.hide();
                        
                        // Reload ingredients
                        loadIngredients();
                    })
                    .catch(error => {
                        console.error('Error updating ingredient:', error);
                        alert('Failed to update ingredient. Please try again.');
                    });
                });
                
                // Delete Ingredient confirmation
                document.getElementById('confirmDeleteIngredientBtn').addEventListener('click', function() {
                    const id = document.getElementById('deleteIngredientId').value;
                    
                    if (!id) {
                        alert('Invalid ingredient ID.');
                        return;
                    }
                    
                    // Send DELETE request to API
                    fetch(`/api/ingredients/${id}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to delete ingredient');
                        }
                        
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteIngredientModal'));
                        modal.hide();
                        
                        // Reload ingredients
                        loadIngredients();
                    })
                    .catch(error => {
                        console.error('Error deleting ingredient:', error);
                        alert('Failed to delete ingredient. Please try again.');
                    });
                });
                
                // Add Recipe form
                document.getElementById('addIngredientToRecipeBtn').addEventListener('click', function() {
                    const container = document.getElementById('recipeIngredientsContainer');
                    const newRow = document.createElement('div');
                    newRow.className = 'row mb-2 recipe-ingredient-row';
                    
                    newRow.innerHTML = `
                        <div class="col-md-8">
                            <select class="form-select ingredient-select" required>
                                <option value="">Select Ingredient</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control ingredient-quantity" placeholder="Quantity" min="1" required>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-danger remove-ingredient"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    
                    container.appendChild(newRow);
                    
                    // Add event listener to remove button
                    newRow.querySelector('.remove-ingredient').addEventListener('click', function() {
                        newRow.remove();
                    });
                    
                    // Populate the new dropdown
                    const select = newRow.querySelector('.ingredient-select');
                    allIngredients.forEach(ingredient => {
                        if (ingredient === '$id') return;
                        
                        const option = document.createElement('option');
                        option.value = ingredient.id;
                        option.textContent = ingredient.name;
                        select.appendChild(option);
                    });
                });
                
                // Save Recipe
                document.getElementById('saveRecipeBtn').addEventListener('click', function() {
                    const name = document.getElementById('recipeName').value.trim();
                    const servingSize = parseInt(document.getElementById('recipeServingSize').value);
                    
                    if (!name || isNaN(servingSize) || servingSize < 1) {
                        alert('Please enter a valid recipe name and serving size.');
                        return;
                    }
                    
                    // Get ingredients
                    const ingredientRows = document.querySelectorAll('#recipeIngredientsContainer .recipe-ingredient-row');
                    const recipeIngredients = [];
                    
                    let valid = true;
                    ingredientRows.forEach(row => {
                        const ingredientId = row.querySelector('.ingredient-select').value;
                        const quantity = parseInt(row.querySelector('.ingredient-quantity').value);
                        
                        if (!ingredientId || isNaN(quantity) || quantity < 1) {
                            valid = false;
                            return;
                        }
                        
                        recipeIngredients.push({
                            ingredientId: ingredientId,
                            requiredQuantity: quantity
                        });
                    });
                    
                    if (!valid || recipeIngredients.length === 0) {
                        alert('Please add at least one valid ingredient to the recipe.');
                        return;
                    }
                    
                    // Create recipe object
                    const newRecipe = {
                        name: name,
                        servingSize: servingSize,
                        ingredients: recipeIngredients
                    };
                    
                    // Send POST request to API
                    fetch('/api/recipes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newRecipe)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to add recipe');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addRecipeModal'));
                        modal.hide();
                        
                        // Clear form
                        document.getElementById('recipeName').value = '';
                        document.getElementById('recipeServingSize').value = '';
                        document.getElementById('recipeIngredientsContainer').innerHTML = `
                            <div class="row mb-2 recipe-ingredient-row">
                                <div class="col-md-8">
                                    <select class="form-select ingredient-select" required>
                                        <option value="">Select Ingredient</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control ingredient-quantity" placeholder="Quantity" min="1" required>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger remove-ingredient"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        `;
                        
                        // Reload recipes
                        loadRecipes();
                        
                        // Repopulate ingredient dropdowns
                        populateIngredientDropdowns();
                    })
                    .catch(error => {
                        console.error('Error adding recipe:', error);
                        alert('Failed to add recipe. Please try again.');
                    });
                });
            }
                    
            // Function to load recipes
            function loadRecipes() {
                const container = document.getElementById('recipes-container');
                container.innerHTML = `
                    <div class="d-flex justify-content-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                fetch('/api/recipes')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Recipes API response:', data);
                        container.innerHTML = '';
                        
                        // Handle ASP.NET Core JSON reference format with $values
                        const recipesArray = Array.isArray(data) ? data : 
                                              (data.$values || data.value || []);
                        console.log('Processed recipes array:', recipesArray);
                        
                        // Store recipes globally
                        allRecipes = recipesArray;
                        
                        if (recipesArray.length === 0) {
                            container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No recipes available. Add some recipes to get started.</div>';
                            return;
                        }
                        
                        // Create a list group for recipes
                        const listGroup = document.createElement('div');
                        listGroup.className = 'list-group';
                        container.appendChild(listGroup);
                        
                        recipesArray.forEach(recipe => {
                            // Skip $id properties
                            if (recipe === '$id') return;
                            
                            // Store recipe ingredients for later use in popup
                            const recipeIngredients = recipe.ingredients && recipe.ingredients.$values ? recipe.ingredients.$values : 
                                                   (recipe.ingredients || []);
                            
                            // Create a list item for each recipe
                            const listItem = document.createElement('div');
                            listItem.className = 'list-group-item d-flex justify-content-between align-items-center recipe-item';
                            listItem.style.backgroundColor = 'rgba(255,255,255,0.05)';
                            listItem.style.border = '1px solid rgba(255,255,255,0.1)';
                            listItem.style.marginBottom = '0.5rem';
                            listItem.style.borderRadius = '8px';
                            
                            listItem.innerHTML = `
                                <div class="d-flex align-items-center recipe-info" data-id="${recipe.id}">
                                    <i class="fas fa-utensils me-2" style="color: white;"></i>
                                    <span class="recipe-name" style="color: white;">${recipe.name}</span>
                                    <span class="badge bg-success ms-2">Feeds ${recipe.servingSize}</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-warning edit-recipe-btn me-1" data-id="${recipe.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-recipe-btn" data-id="${recipe.id}" data-name="${recipe.name}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                            
                            // Add click event to show ingredients popup
                            listItem.querySelector('.recipe-info').addEventListener('click', function() {
                                // Create ingredients list HTML
                                let ingredientsListHtml = '';
                                recipeIngredients.forEach(ri => {
                                    const ingredientName = ri.ingredient && ri.ingredient.name ? ri.ingredient.name : 'Unknown';
                                    ingredientsListHtml += `<li>${ri.requiredQuantity} x ${ingredientName}</li>`;
                                });
                                
                                // Set modal content
                                document.getElementById('recipeDetailsModalLabel').textContent = recipe.name;
                                document.getElementById('recipeServingSize').textContent = recipe.servingSize;
                                document.getElementById('recipeIngredientsList').innerHTML = ingredientsListHtml;
                                
                                // Show modal
                                const recipeDetailsModal = new bootstrap.Modal(document.getElementById('recipeDetailsModal'));
                                recipeDetailsModal.show();
                            });
                            
                            // Add event listeners for edit and delete buttons
                            listItem.querySelector('.edit-recipe-btn').addEventListener('click', function() {
                                const recipeId = this.getAttribute('data-id');
                                
                                // Find the recipe in the global array
                                const recipeToEdit = allRecipes.find(r => r.id === recipeId);
                                if (!recipeToEdit) return;
                                
                                // Populate edit form
                                document.getElementById('editRecipeId').value = recipeId;
                                document.getElementById('editRecipeName').value = recipeToEdit.name;
                                document.getElementById('editRecipeServingSize').value = recipeToEdit.servingSize;
                                
                                // Clear existing ingredients container
                                const ingredientsContainer = document.getElementById('editRecipeIngredientsContainer');
                                ingredientsContainer.innerHTML = '';
                                
                                // Add existing ingredients
                                const recipeIngredients = recipeToEdit.ingredients && recipeToEdit.ingredients.$values ? 
                                                        recipeToEdit.ingredients.$values : (recipeToEdit.ingredients || []);
                                
                                recipeIngredients.forEach(ri => {
                                    const ingredientId = ri.ingredient && ri.ingredient.id ? ri.ingredient.id : 
                                                      (ri.ingredientId || '');
                                    const quantity = ri.requiredQuantity || 0;
                                    
                                    const row = document.createElement('div');
                                    row.className = 'row mb-2 recipe-ingredient-row';
                                    row.innerHTML = `
                                        <div class="col-md-8">
                                            <select class="form-select ingredient-select" required>
                                                <option value="">Select Ingredient</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control ingredient-quantity" value="${quantity}" placeholder="Quantity" min="1" required>
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-danger remove-ingredient"><i class="fas fa-times"></i></button>
                                        </div>
                                    `;
                                    
                                    ingredientsContainer.appendChild(row);
                                    
                                    // Add event listener to remove button
                                    row.querySelector('.remove-ingredient').addEventListener('click', function() {
                                        row.remove();
                                    });
                                    
                                    // Populate the dropdown
                                    const select = row.querySelector('.ingredient-select');
                                    allIngredients.forEach(ingredient => {
                                        if (ingredient === '$id') return;
                                        
                                        const option = document.createElement('option');
                                        option.value = ingredient.id;
                                        option.textContent = ingredient.name;
                                        
                                        // Select the current ingredient
                                        if (ingredient.id === ingredientId) {
                                            option.selected = true;
                                        }
                                        
                                        select.appendChild(option);
                                    });
                                });
                                
                                // Show modal
                                const editModal = new bootstrap.Modal(document.getElementById('editRecipeModal'));
                                editModal.show();
                            });
                            
                            // Delete recipe button
                            listItem.querySelector('.delete-recipe-btn').addEventListener('click', function() {
                                const id = this.getAttribute('data-id');
                                const name = this.getAttribute('data-name');
                                
                                // Populate delete confirmation
                                document.getElementById('deleteRecipeId').value = id;
                                document.getElementById('deleteRecipeName').textContent = name;
                                
                                // Show modal
                                const deleteModal = new bootstrap.Modal(document.getElementById('deleteRecipeModal'));
                                deleteModal.show();
                            });
                        
                        listGroup.appendChild(listItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading recipes:', error);
                    document.getElementById('recipes-container').innerHTML = 
                        '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading recipes</div>';
                });
                
            // Optimize button click handler
            document.getElementById('optimize-btn').addEventListener('click', function() {
                // Disable button and show loading state
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Optimizing...';
                
                // Show the modal with loading state
                const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
                document.getElementById('results-loading').classList.remove('d-none');
                document.getElementById('results-content').classList.add('d-none');
                resultsModal.show();
                
                fetch('/api/optimizer/optimize')
                    .then(response => response.json())
                    .then(data => {
                        // Handle ASP.NET Core JSON reference format with $values
                        const result = data.$values ? { totalPeopleServed: data.totalPeopleServed, recipes: data.$values } :
                                     (data.value ? { totalPeopleServed: data.totalPeopleServed, recipes: data.value } : data);
                        
                        // Hide loading, show content
                        document.getElementById('results-loading').classList.add('d-none');
                        document.getElementById('results-content').classList.remove('d-none');
                        
                        // Display results
                        document.getElementById('people-served').textContent = result.totalPeopleServed;
                        
                        // Display optimal recipes
                        const recipesContainer = document.getElementById('optimal-recipes');
                        recipesContainer.innerHTML = '';
                        
                        // Re-enable the button
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-magic me-2" style="color: white;"></i>Optimize Recipes';
                        
                        // Handle recipe counts with ASP.NET Core JSON reference format
                        const recipes = result.recipes && result.recipes.$values ? result.recipes.$values : (result.recipes || []);
                        console.log('Optimization results:', result);
                        console.log('Recipe counts:', recipes);
                        
                        // Sort optimization results by total people fed (highest to lowest)
                        recipes.sort((a, b) => {
                            const totalPeopleA = (a.recipe?.servingSize || 0) * (a.count || 0);
                            const totalPeopleB = (b.recipe?.servingSize || 0) * (b.count || 0);
                            return totalPeopleB - totalPeopleA; // Descending order
                        });
                        
                        recipes.forEach(recipeCount => {
                            // Skip $id properties
                            if (recipeCount === '$id' || recipeCount.$id === '$id') return;
                            
                            const recipe = recipeCount.recipe;
                            if (!recipe) return; // Skip if recipe is undefined
                            
                            const div = document.createElement('div');
                            div.className = 'alert alert-info';
                            div.innerHTML = `
                                <i class="fas fa-utensils me-2" style="color: white;"></i><strong style="color: white;">${recipe.name}</strong> x ${recipeCount.count} 
                                <span class="badge bg-success float-end">Feeds ${recipe.servingSize * recipeCount.count} people</span>
                            `;
                            recipesContainer.appendChild(div);
                        });
                        
                        // Display remaining ingredients
                        const ingredientsContainer = document.getElementById('remaining-ingredients');
                        ingredientsContainer.innerHTML = '';
                        
                        // Filter out $id properties and sort remaining ingredients by quantity (highest to lowest)
                        const remainingIngredients = Object.entries(data.remainingIngredients)
                            .filter(([ingredient, quantity]) => ingredient !== '$id')
                            .sort(([, quantityA], [, quantityB]) => quantityB - quantityA);
                        
                        remainingIngredients.forEach(([ingredient, quantity]) => {
                            const div = document.createElement('div');
                            div.className = 'ingredient-item';
                            div.innerHTML = `
                                <span><i class="fas fa-cube me-2"></i>${ingredient}</span>
                                <span class="badge bg-secondary">${quantity} remaining</span>
                            `;
                            ingredientsContainer.appendChild(div);
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Re-enable the button
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-magic me-2" style="color: white;"></i>Optimize Recipes';
                        
                        // Hide loading, show error in modal
                        document.getElementById('results-loading').classList.add('d-none');
                        document.getElementById('results-content').classList.remove('d-none');
                        document.getElementById('optimal-recipes').innerHTML = 
                            '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error optimizing recipes. Please try again.</div>';
                    });
            });
            
            // Save results button handler removed as requested
        }});
    </script>
    <!-- Fix for ingredient update functionality -->
    <script src="fix-ingredient-update.js"></script>
</body>
</html>
